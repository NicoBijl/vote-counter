name: Deploy Preview

on:
  workflow_run:
    workflows: ["PR Quality"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  deploy:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Download PR Info
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: context.payload.workflow_run.id,
            });
            // We need to find the PR number. 
            // In workflow_run, we get the PR info from the API
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.payload.workflow_run.head_repository.full_name}:${context.payload.workflow_run.head_branch}`,
              state: 'open'
            });
            const pr = prs.data[0];
            if (pr) {
              fs.writeFileSync('pr_number.txt', pr.number.toString());
            }
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Download Unit Report
        uses: actions/download-artifact@v4
        with:
          name: unit-report
          path: public/reports/unit
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: Download Playwright Report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: public/reports/e2e
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: Generate reports index
        run: |
          mkdir -p dist/reports
          cp -r public/reports/* dist/reports/ || true
          {
            echo "<!doctype html><html><head><meta charset='UTF-8'><title>Test Reports</title></head><body>";
            echo "<h1>Test Reports</h1>";
            echo "<ul>";
            if [ -f dist/reports/unit/index.html ]; then
              echo "<li>Unit tests: <a href='./unit/index.html'>coverage report</a></li>";
            else
              echo "<li>Unit tests: report unavailable</li>";
            fi
            if [ -f dist/reports/e2e/index.html ]; then
              echo "<li>E2E tests: <a href='./e2e/index.html'>Playwright report</a></li>";
            else
              echo "<li>E2E tests: report unavailable</li>";
            fi
            echo "</ul></body></html>";
          } > dist/reports/index.html
      - name: Deploy to Firebase
        id: deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_VOTE_COUNTER_C8CD5 }}'
          projectId: vote-counter-c8cd5
          channelId: pr-${{ head_branch }} # This needs logic to get PR number
          expires: 7d
