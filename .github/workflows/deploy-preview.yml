name: Deploy Preview

on:
  workflow_run:
    workflows: ["PR Quality"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  deploy:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Get PR Information
        id: pr_info
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.payload.workflow_run.id;
            const run = await github.rest.actions.getWorkflowRun({ owner, repo, run_id });
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: run.data.head_sha
            });
            if (prs.data.length > 0) {
              core.setOutput('number', prs.data[0].number);
            } else {
              core.setFailed('No open PR found for this run');
            }

      - uses: actions/checkout@v6
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_branch }}

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Unit Report
        uses: actions/download-artifact@v4
        with:
          name: unit-report
          path: dist/reports/unit
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Download Playwright Report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: dist/reports/e2e
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Generate reports index
        run: |
          mkdir -p dist/reports
          {
            echo "<!doctype html><html><head><meta charset='UTF-8'><title>Test Reports</title></head><body>"
            echo "<h1>Test Reports</h1>"
            echo "<ul>"
            if [ -f dist/reports/unit/index.html ]; then
              echo "<li>Unit tests: <a href='./unit/index.html'>coverage report</a></li>"
            else
              echo "<li>Unit tests: report unavailable</li>"
            fi
            if [ -f dist/reports/e2e/index.html ]; then
              echo "<li>E2E tests: <a href='./e2e/index.html'>Playwright report</a></li>"
            else
              echo "<li>E2E tests: report unavailable</li>"
            fi
            echo "</ul></body></html>"
          } > dist/reports/index.html

      - name: Deploy to Firebase
        id: deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_VOTE_COUNTER_C8CD5 }}'
          projectId: vote-counter-c8cd5
          channelId: pr-${{ steps.pr_info.outputs.number }}
          expires: 7d

      - name: Post combined report comment
        uses: actions/github-script@v8
        env:
          PREVIEW_URL: ${{ steps.deploy.outputs.details_url }}
          PR_NUMBER: ${{ steps.pr_info.outputs.number }}
        with:
          script: |
            const marker = 'ðŸš€ Preview deployment ready';
            const body = [
              marker,
              '- Preview URL: ' + process.env.PREVIEW_URL,
              '- Test Reports: ' + process.env.PREVIEW_URL + '/reports/index.html'
            ].join('\n');
            const { owner, repo } = context.repo;
            const issue_number = Number(process.env.PR_NUMBER);
            const comments = await github.paginate(github.rest.issues.listComments, { owner, repo, issue_number });
            const existing = comments.find(c => c.user?.login === 'github-actions[bot]' && c.body?.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
