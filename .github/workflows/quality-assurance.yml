name: Quality Assurance
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
permissions:
  contents: read
  pages: write
  id-token: write
  issues: write
concurrency:
  group: "qa-pages"
  cancel-in-progress: false
jobs:
  unit-tests:
    outputs:
      lines: ${{ steps.coverage_summary.outputs.lines }}
      statements: ${{ steps.coverage_summary.outputs.statements }}
      branches: ${{ steps.coverage_summary.outputs.branches }}
      functions: ${{ steps.coverage_summary.outputs.functions }}
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Run unit tests with coverage
      id: unit_tests
      run: npm run test -- --coverage --coverageReporters=lcov --coverageReporters=json-summary
      continue-on-error: true
    - name: Extract coverage summary
      id: coverage_summary
      if: ${{ always() && hashFiles('coverage/coverage-summary.json') != '' }}
      run: |
        node <<'EOF'
        const fs = require('fs');
        const summaryPath = 'coverage/coverage-summary.json';
        if (!fs.existsSync(summaryPath)) {
          console.log('coverage-summary.json not found');
          process.exit(0);
        }
        const total = JSON.parse(fs.readFileSync(summaryPath, 'utf8')).total;
        const toPct = (section) => Number.parseFloat((section?.pct ?? 0).toFixed(2));
        const lines = toPct(total.lines);
        const statements = toPct(total.statements);
        const branches = toPct(total.branches);
        const functions = toPct(total.functions);
        const outputs = { lines, statements, branches, functions };
        for (const [key, value] of Object.entries(outputs)) {
          console.log(`${key}=${value}`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `${key}=${value}\n`);
        }
        EOF
    - name: Upload unit coverage artifact
      if: ${{ always() && hashFiles('coverage/lcov-report/index.html') != '' }}
      uses: actions/upload-artifact@v4
      with:
        name: unit-report
        path: coverage/lcov-report
        retention-days: 14
    - name: Fail job if unit tests failed
      if: ${{ steps.unit_tests.outcome == 'failure' }}
      run: exit 1

  playwright:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Run Playwright tests
      id: tests
      run: npx playwright test
      continue-on-error: true
    - name: Upload Playwright report artifact
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
    - name: Fail job if tests failed
      if: ${{ steps.tests.outcome == 'failure' }}
      run: exit 1

  publish-reports:
    needs: [unit-tests, playwright]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
    - name: Prepare reports directory
      run: mkdir -p reports/unit reports/e2e reports/coverage
    - name: Download unit report
      uses: actions/download-artifact@v4
      with:
        name: unit-report
        path: reports/unit
      continue-on-error: true
    - name: Download Playwright report
      uses: actions/download-artifact@v4
      with:
        name: playwright-report
        path: reports/e2e
      continue-on-error: true
    - name: Copy coverage report
      run: |
        if [ -f reports/unit/index.html ]; then
          cp -R reports/unit/* reports/coverage/
        fi
    - name: Generate combined index
      run: |
        {
          echo "<!doctype html><html><head><meta charset='UTF-8'><title>Test Reports</title></head><body>";
          echo "<h1>Test Reports</h1>";
          echo "<ul>";
          if [ -f reports/unit/index.html ]; then
            echo "<li>Unit tests: <a href='./unit/index.html'>coverage report</a></li>";
          else
            echo "<li>Unit tests: report unavailable</li>";
          fi
          if [ -f reports/coverage/index.html ]; then
            echo "<li>Coverage: <a href='./coverage/index.html'>coverage report</a></li>";
          else
            echo "<li>Coverage: report unavailable</li>";
          fi
          if [ -f reports/e2e/index.html ]; then
            echo "<li>E2E tests: <a href='./e2e/index.html'>Playwright report</a></li>";
          else
            echo "<li>E2E tests: report unavailable</li>";
          fi
          echo "</ul></body></html>";
        } > reports/index.html
    - name: Upload combined Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: reports

  deploy-report:
    needs: publish-reports
    if: ${{ always() }}
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Deploy combined reports to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  comment-on-pr:
    needs: [deploy-report, unit-tests, playwright]
    if: ${{ github.event.pull_request && always() }}
    runs-on: ubuntu-latest
    steps:
    - name: Comment with report links
      uses: actions/github-script@v7
      env:
        PAGE_URL: ${{ needs.deploy-report.outputs.page_url }}
        UNIT_STATUS: ${{ needs.unit-tests.result }}
        E2E_STATUS: ${{ needs.playwright.result }}
        COV_LINES: ${{ needs.unit-tests.outputs.lines }}
        COV_BRANCHES: ${{ needs.unit-tests.outputs.branches }}
        COV_FUNCTIONS: ${{ needs.unit-tests.outputs.functions }}
        COV_STATEMENTS: ${{ needs.unit-tests.outputs.statements }}
      with:
        script: |
          const pageUrl = process.env.PAGE_URL;
          const unitStatus = process.env.UNIT_STATUS;
          const e2eStatus = process.env.E2E_STATUS;
          const cov = {
            lines: process.env.COV_LINES,
            branches: process.env.COV_BRANCHES,
            functions: process.env.COV_FUNCTIONS,
            statements: process.env.COV_STATEMENTS,
          };
          const formatCov = () => {
            const entries = Object.entries(cov).filter(([, v]) => v !== '' && v != null);
            if (!entries.length) return 'coverage unavailable';
            return entries.map(([k, v]) => `${k}: ${v}%`).join(', ');
          };
          const marker = 'ðŸ§ª Test reports for this PR';
          const unitLink = pageUrl ? `${pageUrl}/unit/index.html` : null;
          const coverageLink = pageUrl ? `${pageUrl}/coverage/index.html` : null;
          const e2eLink = pageUrl ? `${pageUrl}/e2e/index.html` : null;

          const lines = [
            marker,
            `- Unit tests: **${unitStatus}**${unitLink ? ` ([coverage report](${unitLink}))` : ''}`,
            `  - Coverage: ${formatCov()}${coverageLink ? ` ([HTML](${coverageLink}))` : ''}`,
            `- E2E tests: **${e2eStatus}**${e2eLink ? ` ([Playwright report](${e2eLink}))` : ''}`
          ];
          const body = lines.join('\n');

          const { owner, repo } = context.repo;
          const issue_number = context.issue.number;
          const comments = await github.paginate(github.rest.issues.listComments, { owner, repo, issue_number });
          const existing = comments.find(c => c.user?.login === 'github-actions[bot]' && c.body?.includes(marker));

          if (existing) {
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: existing.id,
              body
            });
          } else {
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body
            });
          }
